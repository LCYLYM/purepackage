name: Build from issue

on:
  issues:
    types: [opened, edited, labeled]

jobs:
  build-from-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 检查标签是否需要构建
        id: check-labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.issue.labels || []).map(l => l.name);
            const hasBuildZip = labels.includes('build-zip');
            const hasBuilt = labels.includes('built');
            const shouldRun = hasBuildZip && !hasBuilt;
            core.info(`labels = ${labels.join(', ')}, shouldRun = ${shouldRun}`);
            core.setOutput('should_run', shouldRun ? 'true' : 'false');

      - name: 解析 issue 正文中的 zip 附件链接
        if: steps.check-labels.outputs.should_run == 'true'
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            // 兼容两种形式：
            // 1) 直接 Markdown 链接: [xxx.zip](https://github.com/.../assets/...)
            // 2) 拖拽上传图片形式: ![xxx.zip](https://github.com/.../assets/...)
            const re = /!\[[^\]]*?\.zip\]\((https:\/\/github\.com\/[^)]+)\)|\[[^\]]*?\.zip\]\((https:\/\/github\.com\/[^)]+)\)/i;
            const m = body.match(re);
            if (!m) {
              core.setFailed('在 issue 正文中没有找到 .zip 附件链接，请上传 zip 后重试。');
              return;
            }
            const url = m[1] || m[2];
            core.info(`Detected zip url: ${url}`);
            core.setOutput('zip_url', url);

      - name: 下载 zip 附件
        if: steps.check-labels.outputs.should_run == 'true'
        run: |
          mkdir -p workspace
          echo "Downloading ${{ steps.parse.outputs.zip_url }}"  
          curl -L "${{ steps.parse.outputs.zip_url }}" -o workspace/source.zip

      - name: 占位打包步骤（TODO: 构建 exe / apk）
        if: steps.check-labels.outputs.should_run == 'true'
        run: |
          echo "[purepackage] TODO: 在这里调用真正的打包脚本，例如构建 exe / apk"  
          ls -lh workspace

      - name: 在 issue 中回复并打标签
        if: steps.check-labels.outputs.should_run == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            const repo = context.repo;
            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issueNumber,
              body: '✅ 已收到构建请求，zip 已下载到云端 workspace。后续将接入 exe/apk 构建逻辑。',
            });
            // 添加 built 标签，避免重复触发
            const labels = (context.payload.issue.labels || []).map(l => l.name);
            if (!labels.includes('built')) {
              await github.rest.issues.addLabels({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: issueNumber,
                labels: ['built'],
              });
            }
