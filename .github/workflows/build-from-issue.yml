name: build-from-issue

on:
  issues:
    types: [opened, edited]

jobs:
  build:
    runs-on: windows-latest
    if: "!contains(github.event.issue.labels.*.name, 'built')"
    permissions:
      issues: write
      contents: write
    steps:
      - name: Checkout purepackage
        uses: actions/checkout@v4

      - name: Parse zip link from issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            // Match GitHub user-attachments URL (both /assets/ and /files/) that ends with .zip
            const re = /(https:\/\/github\.com\/user-attachments\/(?:assets|files)\/[^\s)]+\.zip)/i;
            const m = body.match(re);
            if (!m) {
              core.setFailed('No GitHub .zip attachment URL found in issue body. Please upload a .zip file and keep the default link format.');
              return;
            }
            const url = m[1];
            core.info('Detected attachment url: ' + url);
            core.setOutput('zip_url', url);

      - name: Download zip attachment
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path workspace
          $url = "${{ steps.parse.outputs.zip_url }}"
          Write-Host "Downloading $url"
          Invoke-WebRequest -Uri $url -OutFile workspace/source.zip -MaximumRedirection 10
          Get-ChildItem workspace

      - name: Clone aistudioformove
        shell: pwsh
        run: |
          git clone --depth 1 https://github.com/LCYLYM/aistudioformove.git hostapp

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        shell: pwsh
        run: |
          cd hostapp
          npm install

      - name: Extract ZIP and prepare build
        shell: pwsh
        run: |
          Expand-Archive -Path workspace/source.zip -DestinationPath workspace/extracted -Force
          Get-ChildItem -Recurse workspace/extracted | Select-Object FullName
          # 将原始 zip 复制到 Host 的 public 目录，打包为内置应用
          New-Item -ItemType Directory -Force -Path hostapp/public | Out-Null
          Copy-Item workspace/source.zip hostapp/public/embedded-app.zip -Force

      - name: Build Windows exe
        shell: pwsh
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
          VITE_PACKAGE_MODE: 'embedded'
          VITE_EMBED_ZIP_URL: 'embedded-app.zip'
        run: |
          cd hostapp
          npm run build:web
          npm run build:electron

      - name: Upload exe artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: hostapp/dist-electron/*.exe
          if-no-files-found: error

  build-android:
    runs-on: ubuntu-latest
    if: "!contains(github.event.issue.labels.*.name, 'built')"
    permissions:
      issues: write
      contents: write
    steps:
      - name: Checkout purepackage
        uses: actions/checkout@v4

      - name: Parse zip link from issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            // Match GitHub user-attachments URL (both /assets/ and /files/) that ends with .zip
            const re = /(https:\/\/github\.com\/user-attachments\/(?:assets|files)\/[^\s)]+\.zip)/i;
            const m = body.match(re);
            if (!m) {
              core.setFailed('No GitHub .zip attachment URL found in issue body. Please upload a .zip file and keep the default link format.');
              return;
            }
            const url = m[1];
            core.info('Detected attachment url: ' + url);
            core.setOutput('zip_url', url);

      - name: Download zip attachment
        run: |
          mkdir -p workspace
          url="${{ steps.parse.outputs.zip_url }}"
          echo "Downloading $url"
          curl -L "$url" -o workspace/source.zip
          ls -lh workspace

      - name: Clone aistudioformove
        run: |
          git clone --depth 1 https://github.com/LCYLYM/aistudioformove.git hostapp

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd hostapp
          npm install

      - name: Ensure Android platform added
        run: |
          cd hostapp
          npx cap add android || echo "android platform already exists"

      - name: Copy ZIP into host public
        run: |
          mkdir -p hostapp/public
          cp workspace/source.zip hostapp/public/embedded-app.zip

      - name: Build Android APK
        env:
          VITE_PACKAGE_MODE: 'embedded'
          VITE_EMBED_ZIP_URL: 'embedded-app.zip'
        run: |
          cd hostapp
          npm run build:android

      - name: Upload Android APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: hostapp/android/app/build/outputs/apk/release/*.apk
          if-no-files-found: error

      - name: Comment build result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            const repo = context.repo;
            const runId = context.runId;
            const runUrl = `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId}`;

            // List artifacts for this run so we can give direct links
            const { data } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: repo.owner,
              repo: repo.repo,
              run_id: runId,
              per_page: 100,
            });

            const findArtifact = (name) => data.artifacts.find(a => a.name === name);
            const exe = findArtifact('windows-exe');
            const apk = findArtifact('android-apk');

            const exeUrl = exe
              ? `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId}/artifacts/${exe.id}`
              : '（未找到 windows-exe 构建产物）';
            const apkUrl = apk
              ? `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId}/artifacts/${apk.id}`
              : '（未找到 android-apk 构建产物）';

            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issueNumber,
              body: [
                '✅ 构建完成！',
                '',
                '➡️ 工作流运行页面：',
                runUrl,
                '',
                '⬇️ 构建产物直达链接（需登录 GitHub 才能下载）：',
                `- Windows EXE: ${exeUrl}`,
                `- Android APK: ${apkUrl}`,
                '',
                '也可以在该运行页面的 “Artifacts” 区块中，点击对应名称下载。',
              ].join('\n'),
            });

            await github.rest.issues.addLabels({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issueNumber,
              labels: ['built'],
            });
