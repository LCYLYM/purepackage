name: build-from-issue

on:
  issues:
    types: [opened, edited, labeled]

jobs:
  build-from-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse zip link from issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            // Support both markdown link [xxx.zip](...) and image-like link ![xxx.zip](...)
            const re = /!\[[^\]]*?\.zip\]\((https:\/\/github\.com\/[^)]+)\)|\[[^\]]*?\.zip\]\((https:\/\/github\.com\/[^)]+)\)/i;
            const m = body.match(re);
            if (!m) {
              core.setFailed('No .zip link found in issue body. Please upload a zip file and include its link.');
              return;
            }
            const url = m[1] || m[2];
            core.info(`Detected zip url: ${url}`);
            core.setOutput('zip_url', url);

      - name: Download zip attachment
        run: |
          mkdir -p workspace
          echo "Downloading ${{ steps.parse.outputs.zip_url }}"
          curl -L "${{ steps.parse.outputs.zip_url }}" -o workspace/source.zip

      - name: Placeholder build step (TODO: build exe / apk)
        run: echo "[purepackage] TODO: build exe / apk from workspace/source.zip" && ls -lh workspace

      - name: Comment and label issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            const repo = context.repo;
            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issueNumber,
              body: 'âœ… Build request received. Zip has been downloaded to the workflow workspace. TODO: hook real exe/apk build logic.',
            });
            // Add "built" label idempotently
            const labels = (context.payload.issue.labels || []).map(l => l.name);
            if (!labels.includes('built')) {
              await github.rest.issues.addLabels({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: issueNumber,
                labels: ['built'],
              });
            }
