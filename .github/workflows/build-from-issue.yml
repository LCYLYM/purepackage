name: build-from-issue

on:
  issues:
    types: [opened, edited]

jobs:
  build:
    runs-on: windows-latest
    if: "!contains(github.event.issue.labels.*.name, 'built')"
    permissions:
      issues: write
      contents: write
    steps:
      - name: Checkout purepackage
        uses: actions/checkout@v4

      - name: Parse zip link from issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            // Match GitHub user-attachments URL (both /assets/ and /files/) that ends with .zip
            const re = /(https:\/\/github\.com\/user-attachments\/(?:assets|files)\/[^\s)]+\.zip)/i;
            const m = body.match(re);
            if (!m) {
              core.setFailed('No GitHub .zip attachment URL found in issue body. Please upload a .zip file and keep the default link format.');
              return;
            }
            const url = m[1];
            core.info('Detected attachment url: ' + url);
            core.setOutput('zip_url', url);

      - name: Download zip attachment
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path workspace
          $url = "${{ steps.parse.outputs.zip_url }}"
          Write-Host "Downloading $url"
          Invoke-WebRequest -Uri $url -OutFile workspace/source.zip -MaximumRedirection 10
          Get-ChildItem workspace

      - name: Clone aistudioformove
        shell: pwsh
        run: |
          git clone --depth 1 https://github.com/LCYLYM/aistudioformove.git hostapp

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        shell: pwsh
        run: |
          cd hostapp
          npm install

      - name: Extract ZIP and prepare build
        shell: pwsh
        run: |
          Expand-Archive -Path workspace/source.zip -DestinationPath workspace/extracted -Force
          Get-ChildItem -Recurse workspace/extracted | Select-Object FullName
          # 将原始 zip 复制到 Host 的 public 目录，打包为内置应用
          New-Item -ItemType Directory -Force -Path hostapp/public | Out-Null
          Copy-Item workspace/source.zip hostapp/public/embedded-app.zip -Force

      - name: Build Windows exe
        shell: pwsh
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
          VITE_PACKAGE_MODE: 'embedded'
          VITE_EMBED_ZIP_URL: 'embedded-app.zip'
        run: |
          cd hostapp
          npm run build:web
          npm run build:electron

      - name: Upload exe artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: hostapp/dist-electron/*.exe
          if-no-files-found: error

      - name: Comment build result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            const repo = context.repo;
            const runUrl = `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${context.runId}`;
            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issueNumber,
              body: `✅ Build completed!\n\n[View workflow run](${runUrl}) to download artifacts (exe).\n\n_APK build coming soon._`,
            });
            await github.rest.issues.addLabels({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issueNumber,
              labels: ['built'],
            });
